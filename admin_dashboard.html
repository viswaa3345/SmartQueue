<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Queue - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #ff9a56 0%, #ff6b35 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            color: #ff6b35 !important;
            font-size: 1.5rem;
        }
        
        .container-main {
            padding: 20px 0;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        .card-header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 20px;
            border: none;
        }
        
        .card-header h5 {
            margin: 0;
            font-weight: 600;
        }
        
        .card-body {
            padding: 20px;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .stats-number {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }
        
        .stats-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .token-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-left: 5px solid;
        }
        
        .token-item.active {
            border-left-color: #28a745;
        }
        
        .token-item.called {
            border-left-color: #ffc107;
        }
        
        .token-item.completed {
            border-left-color: #6c757d;
        }
        
        .token-item.cancelled {
            border-left-color: #dc3545;
        }
        
        .token-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #ff6b35;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .alert {
            border-radius: 12px;
        }
        
        .table {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .table thead th {
            background: #f8f9fa;
            border: none;
            font-weight: 600;
            color: #333;
        }
        
        .badge {
            font-size: 0.8rem;
            padding: 6px 12px;
        }
        
        .nav-tabs .nav-link {
            border-radius: 12px 12px 0 0;
            border: none;
            background: rgba(255, 255, 255, 0.7);
            margin-right: 5px;
            color: #666;
        }
        
        .nav-tabs .nav-link.active {
            background: white;
            color: #ff6b35;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-utensils"></i> Smart Queue - Admin
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">Welcome, <span id="adminName">Admin</span>!</span>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container container-main">
        <!-- Stats Overview -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <span class="stats-number" id="activeTokens">0</span>
                    <span class="stats-label">Active Tokens</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);">
                    <span class="stats-number" id="calledTokens">0</span>
                    <span class="stats-label">Called Tokens</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%);">
                    <span class="stats-number" id="completedTokens">0</span>
                    <span class="stats-label">Completed Today</span>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <span class="stats-number" id="totalCustomers">0</span>
                    <span class="stats-label">Total Customers</span>
                </div>
            </div>
        </div>

        <!-- Main Content Tabs -->
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="adminTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue" type="button" role="tab">
                            <i class="fas fa-list"></i> Queue Management
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu" type="button" role="tab">
                            <i class="fas fa-hamburger"></i> Food Menu
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="adminTabsContent">
                    <!-- Queue Management Tab -->
                    <div class="tab-pane fade show active" id="queue" role="tabpanel">
                        <div id="alertContainer"></div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Active Queue</h5>
                            <button class="btn btn-primary btn-sm" onclick="refreshTokens()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                        
                        <div class="loading" id="tokensLoading">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Loading tokens...</p>
                        </div>
                        
                        <div id="tokensList">
                            <!-- Tokens will be populated here -->
                        </div>
                    </div>

                    <!-- Food Menu Tab -->
                    <div class="tab-pane fade" id="menu" role="tabpanel">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5>Food Menu Management</h5>
                            <button class="btn btn-primary" onclick="showAddFoodModal()">
                                <i class="fas fa-plus"></i> Add Food Item
                            </button>
                        </div>
                        
                        <div class="loading" id="menuLoading">
                            <i class="fas fa-spinner fa-spin fa-2x"></i>
                            <p class="mt-2">Loading menu...</p>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table" id="menuTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Category</th>
                                        <th>Price</th>
                                        <th>Prep Time</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="menuTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div class="tab-pane fade" id="settings" role="tabpanel">
                        <h5>System Settings</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Average Service Time (minutes)</label>
                                    <input type="number" class="form-control" id="serviceTime" value="5">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Notification Advance Time (minutes)</label>
                                    <input type="number" class="form-control" id="notificationTime" value="5">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Token Expiry Time (minutes)</label>
                                    <input type="number" class="form-control" id="expiryTime" value="60">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Pickup Radius (meters)</label>
                                    <input type="number" class="form-control" id="pickupRadius" value="100">
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Food Modal -->
    <div class="modal fade" id="foodModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="foodModalTitle">Add Food Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="foodForm">
                        <input type="hidden" id="foodId">
                        <div class="mb-3">
                            <label class="form-label">Name</label>
                            <input type="text" class="form-control" id="foodName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="foodDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Price ($)</label>
                                    <input type="number" step="0.01" class="form-control" id="foodPrice" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Category</label>
                                    <input type="text" class="form-control" id="foodCategory">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Preparation Time (minutes)</label>
                            <input type="number" class="form-control" id="foodPrepTime" value="5">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveFoodItem()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTokens = [];
        let currentMenu = [];

        // Initialize on page load
        window.addEventListener('load', function() {
            checkAuth();
            loadDashboardData();
            
            // Auto-refresh every 30 seconds
            setInterval(() => {
                loadTokens();
                loadStats();
            }, 30000);
        });

        async function checkAuth() {
            try {
                const response = await fetch('api/check_session.php');
                const result = await response.json();
                
                if (!result.authenticated) {
                    // Try to restore session from localStorage
                    const currentUser = localStorage.getItem('currentUser');
                    if (currentUser) {
                        try {
                            const userData = JSON.parse(currentUser);
                            if (userData.role === 'admin' || userData.selectedRole === 'admin') {
                                const restoreResponse = await fetch('api/check_session.php', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify({
                                        action: 'restore_session',
                                        user_data: userData
                                    })
                                });
                                
                                const restoreResult = await restoreResponse.json();
                                if (restoreResult.success) {
                                    console.log('Admin session restored successfully');
                                    document.getElementById('adminName').textContent = userData.name;
                                    return;
                                }
                            }
                        } catch (restoreError) {
                            console.error('Session restore failed:', restoreError);
                        }
                    }
                    
                    // If session restore fails, redirect to login
                    window.location.href = 'index.html';
                    return;
                }
                
                if (result.user.role !== 'admin') {
                    window.location.href = 'user_dashboard.html';
                    return;
                }
                
                document.getElementById('adminName').textContent = result.user.name || result.user.username;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = 'index.html';
            }
        }

        function loadDashboardData() {
            loadTokens();
            loadMenu();
            loadStats();
        }

        async function loadTokens() {
            try {
                const response = await fetch('api/admin_tokens.php');
                const result = await response.json();
                
                document.getElementById('tokensLoading').style.display = 'none';
                
                if (result.success) {
                    currentTokens = result.tokens;
                    displayTokens(currentTokens);
                    updateStats(result.stats);
                } else {
                    showAlert('danger', 'Failed to load tokens: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                document.getElementById('tokensLoading').style.display = 'none';
                console.error('Token loading error:', error);
                showAlert('danger', 'Error loading tokens: ' + error.message);
            }
        }

        function displayTokens(tokens) {
            const tokensList = document.getElementById('tokensList');
            
            if (tokens.length === 0) {
                tokensList.innerHTML = '<div class="text-center py-4"><p>No active tokens in queue</p></div>';
                return;
            }
            
            let html = '';
            tokens.forEach(token => {
                html += `
                    <div class="token-item ${token.status}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="token-number">${token.token_number}</span>
                                <div class="mt-1">
                                    <strong>${token.user_name || 'Unknown Customer'}</strong><br>
                                    <small class="text-muted">${token.user_email || ''}</small><br>
                                    ${token.food_name || 'Unknown Item'} (x${token.quantity})<br>
                                    <small class="text-muted">Created: ${formatDateTime(token.created_at)}</small>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="mb-2">
                                    <span class="badge bg-${getStatusColor(token.status)}">${token.status.toUpperCase()}</span>
                                </div>
                                ${getTokenActions(token)}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            tokensList.innerHTML = html;
        }

        function updateStats(stats) {
            // Update the dashboard statistics cards
            document.getElementById('activeTokens').textContent = stats.active || 0;
            document.getElementById('calledTokens').textContent = stats.called || 0;
            document.getElementById('completedTokens').textContent = stats.completed_today || 0;
            document.getElementById('totalCustomers').textContent = stats.total_customers || 0;
        }

        function getStatusColor(status) {
            const colors = {
                'active': 'success',
                'called': 'warning',
                'completed': 'secondary',
                'cancelled': 'danger'
            };
            return colors[status] || 'secondary';
        }

        function getTokenActions(token) {
            if (token.status === 'active') {
                return `
                    <button class="btn btn-warning btn-sm me-1" onclick="callToken(${token.id})">
                        <i class="fas fa-bell"></i> Call
                    </button>
                    <button class="btn btn-success btn-sm me-1" onclick="completeToken(${token.id})">
                        <i class="fas fa-check"></i> Complete
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="cancelToken(${token.id})">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                `;
            } else if (token.status === 'called') {
                return `
                    <button class="btn btn-success btn-sm me-1" onclick="completeToken(${token.id})">
                        <i class="fas fa-check"></i> Complete
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="reactivateToken(${token.id})">
                        <i class="fas fa-undo"></i> Reactivate
                    </button>
                `;
            }
            return '';
        }

        async function callToken(tokenId) {
            await updateTokenStatus(tokenId, 'call');
        }

        async function completeToken(tokenId) {
            await updateTokenStatus(tokenId, 'complete');
        }

        async function cancelToken(tokenId) {
            if (!confirm('Are you sure you want to cancel this token?')) return;
            await updateTokenStatus(tokenId, 'cancel');
        }

        async function reactivateToken(tokenId) {
            await updateTokenStatus(tokenId, 'reactivate');
        }

        async function updateTokenStatus(tokenId, status) {
            try {
                const response = await fetch('api/admin_token.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token_id: tokenId, action: status })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('success', result.message);
                    loadTokens();
                    loadStats();
                } else {
                    showAlert('danger', result.error);
                }
            } catch (error) {
                showAlert('danger', 'Error updating token status');
            }
        }

        async function loadMenu() {
            try {
                const response = await fetch('api/food_items.php');
                const result = await response.json();
                
                document.getElementById('menuLoading').style.display = 'none';
                
                if (result.success) {
                    currentMenu = result.items;
                    displayMenu(currentMenu);
                } else {
                    showAlert('danger', 'Failed to load menu');
                }
            } catch (error) {
                document.getElementById('menuLoading').style.display = 'none';
                showAlert('danger', 'Error loading menu');
            }
        }

        function displayMenu(items) {
            const tableBody = document.getElementById('menuTableBody');
            document.getElementById('menuTable').style.display = 'table';
            
            let html = '';
            items.forEach(item => {
                html += `
                    <tr>
                        <td>
                            <strong>${item.name}</strong><br>
                            <small class="text-muted">${item.description}</small>
                        </td>
                        <td>${item.category || '-'}</td>
                        <td>$${parseFloat(item.price).toFixed(2)}</td>
                        <td>${item.preparation_time} min</td>
                        <td>
                            <span class="badge bg-${item.is_available ? 'success' : 'danger'}">
                                ${item.is_available ? 'Available' : 'Unavailable'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary btn-sm me-1" onclick="editFoodItem(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteFoodItem(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        async function loadStats() {
            try {
                // This would typically be a separate stats API endpoint
                const activeCount = currentTokens.filter(t => t.status === 'active').length;
                const calledCount = currentTokens.filter(t => t.status === 'called').length;
                const completedCount = currentTokens.filter(t => t.status === 'completed').length;
                
                document.getElementById('activeTokens').textContent = activeCount;
                document.getElementById('calledTokens').textContent = calledCount;
                document.getElementById('completedTokens').textContent = completedCount;
                document.getElementById('totalCustomers').textContent = currentTokens.length;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        function refreshTokens() {
            document.getElementById('tokensLoading').style.display = 'block';
            loadTokens();
            loadStats();
        }

        function showAddFoodModal() {
            document.getElementById('foodModalTitle').textContent = 'Add Food Item';
            document.getElementById('foodForm').reset();
            document.getElementById('foodId').value = '';
            new bootstrap.Modal(document.getElementById('foodModal')).show();
        }

        function editFoodItem(itemId) {
            const item = currentMenu.find(i => i.id == itemId);
            if (item) {
                document.getElementById('foodModalTitle').textContent = 'Edit Food Item';
                document.getElementById('foodId').value = item.id;
                document.getElementById('foodName').value = item.name;
                document.getElementById('foodDescription').value = item.description;
                document.getElementById('foodPrice').value = item.price;
                document.getElementById('foodCategory').value = item.category;
                document.getElementById('foodPrepTime').value = item.preparation_time;
                new bootstrap.Modal(document.getElementById('foodModal')).show();
            }
        }

        async function saveFoodItem() {
            // Validate form data
            const name = document.getElementById('foodName').value.trim();
            const price = document.getElementById('foodPrice').value;
            
            if (!name) {
                showAlert('danger', 'Food name is required');
                return;
            }
            
            if (!price || isNaN(price) || parseFloat(price) <= 0) {
                showAlert('danger', 'Valid price is required');
                return;
            }
            
            const formData = {
                id: document.getElementById('foodId').value,
                name: name,
                description: document.getElementById('foodDescription').value.trim(),
                price: parseFloat(price),
                category: document.getElementById('foodCategory').value.trim(),
                preparation_time: parseInt(document.getElementById('foodPrepTime').value) || 5
            };
            
            const isEdit = formData.id !== '';
            const method = isEdit ? 'PUT' : 'POST';
            
            console.log('Saving food item:', method, formData);
            
            try {
                const response = await fetch('api/food_items.php', {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('API response:', result);
                
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('foodModal')).hide();
                    showAlert('success', result.message);
                    loadMenu();
                } else {
                    console.error('API error:', result.error);
                    showAlert('danger', result.error || 'Unknown error occurred');
                }
            } catch (error) {
                console.error('Save food item error:', error);
                showAlert('danger', 'Error saving food item: ' + error.message);
            }
        }

        async function deleteFoodItem(itemId) {
            if (!confirm('Are you sure you want to remove this food item?')) return;
            
            try {
                const response = await fetch('api/food_items.php', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: itemId })
                });
                
                const result = await response.json();
                if (result.success) {
                    showAlert('success', result.message);
                    loadMenu();
                } else {
                    showAlert('danger', result.error);
                }
            } catch (error) {
                showAlert('danger', 'Error deleting food item');
            }
        }

        function saveSettings() {
            showAlert('success', 'Settings saved successfully (feature to be implemented)');
        }

        async function logout() {
            try {
                const response = await fetch('api/logout.php', { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    window.location.href = 'index.html';
                }
            } catch (error) {
                window.location.href = 'index.html';
            }
        }

        function formatDateTime(datetime) {
            return new Date(datetime).toLocaleString();
        }

        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            alertContainer.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            if (type === 'success') {
                setTimeout(() => {
                    const alert = alertContainer.querySelector('.alert');
                    if (alert) alert.remove();
                }, 5000);
            }
        }
    </script>
</body>
</html>
