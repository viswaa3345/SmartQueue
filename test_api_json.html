<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food API Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .result { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 15px; 
            margin: 10px 0; 
            white-space: pre-wrap; 
            font-family: monospace; 
        }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üß™ Food API JSON Test</h1>
        
        <div class="row">
            <div class="col-md-6">
                <h3>1. Login as Admin</h3>
                <button class="btn btn-primary" onclick="loginAdmin()">Login Admin</button>
                <div id="loginResult" class="result"></div>
            </div>
            
            <div class="col-md-6">
                <h3>2. Test GET Request</h3>
                <button class="btn btn-info" onclick="testGet()">Test GET</button>
                <div id="getResult" class="result"></div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h3>3. Test POST Request</h3>
                <button class="btn btn-success" onclick="testPost()">Test POST</button>
                <div id="postResult" class="result"></div>
            </div>
            
            <div class="col-md-6">
                <h3>4. Raw Response Check</h3>
                <button class="btn btn-warning" onclick="checkRawResponse()">Check Raw Response</button>
                <div id="rawResult" class="result"></div>
            </div>
        </div>
        
        <div class="mt-4">
            <a href="admin_dashboard.html" class="btn btn-secondary">‚Üê Back to Admin Dashboard</a>
        </div>
    </div>

    <script>
        let currentUser = null;
        
        async function loginAdmin() {
            const resultDiv = document.getElementById('loginResult');
            try {
                const response = await fetch('auth/login.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'email=admin@restaurant.com&password=admin123&role=admin'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'Login successful!\n' + JSON.stringify(result, null, 2);
                    
                    // Store in localStorage
                    localStorage.setItem('currentUser', JSON.stringify({
                        id: result.user.id,
                        email: result.user.email,
                        name: result.user.name,
                        role: result.user.role,
                        selectedRole: 'admin'
                    }));
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'Login failed!\n' + JSON.stringify(result, null, 2);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Login error: ' + error.message;
            }
        }
        
        async function testGet() {
            const resultDiv = document.getElementById('getResult');
            try {
                const response = await fetch('api/food_items.php');
                const result = await response.json();
                
                resultDiv.className = 'result success';
                resultDiv.textContent = 'GET Response:\n' + JSON.stringify(result, null, 2);
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'GET error: ' + error.message;
            }
        }
        
        async function testPost() {
            const resultDiv = document.getElementById('postResult');
            
            if (!currentUser) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Please login first!';
                return;
            }
            
            const testData = {
                name: 'API Test Item',
                description: 'Test item from API test page',
                price: 15.99,
                category: 'Test Category',
                preparation_time: 10
            };
            
            try {
                const response = await fetch('api/food_items.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = 'POST successful!\n' + JSON.stringify(result, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = 'POST failed!\n' + JSON.stringify(result, null, 2);
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'POST error: ' + error.message;
            }
        }
        
        async function checkRawResponse() {
            const resultDiv = document.getElementById('rawResult');
            
            try {
                const response = await fetch('api/food_items.php');
                const text = await response.text();
                
                resultDiv.className = 'result';
                resultDiv.innerHTML = '<strong>Raw Response:</strong><br>' + 
                    '<strong>Status:</strong> ' + response.status + '<br>' +
                    '<strong>Content-Type:</strong> ' + response.headers.get('content-type') + '<br>' +
                    '<strong>Body:</strong><br>' + text.substring(0, 1000) + (text.length > 1000 ? '...(truncated)' : '');
                
                // Try to parse as JSON
                try {
                    const json = JSON.parse(text);
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML += '<br><br><strong>JSON Parse:</strong> ‚úÖ Valid JSON';
                } catch (e) {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML += '<br><br><strong>JSON Parse Error:</strong> ' + e.message;
                }
                
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = 'Raw check error: ' + error.message;
            }
        }
        
        // Auto-login on page load
        window.addEventListener('load', function() {
            loginAdmin();
        });
    </script>
</body>
</html>